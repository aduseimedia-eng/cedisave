<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#006B3F">
  <title>Bills Due - KudiPal</title>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* ===== MTN-Style Header for Bills ===== */
    .mtn-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #004d2c 60%, #003822 100%);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding-top: env(safe-area-inset-top, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      overflow: hidden;
    }

    .mtn-header::before {
      content: '';
      position: absolute;
      top: -40%;
      right: -15%;
      width: 200px;
      height: 200px;
      background: rgba(255,255,255,0.06);
      border-radius: 50%;
    }

    .mtn-header::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 160px;
      height: 160px;
      background: rgba(255,255,255,0.04);
      border-radius: 50%;
    }

    .mtn-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px 0 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-back-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .mtn-back-btn:active {
      transform: scale(0.92);
      background: rgba(255,255,255,0.2);
    }

    .mtn-back-btn i {
      width: 18px;
      height: 18px;
    }

    .mtn-page-title {
      font-size: 17px;
      font-weight: 700;
      color: white;
      letter-spacing: -0.2px;
    }

    .mtn-topbar-spacer {
      width: 36px;
    }

    /* Bills info section inside header */
    .mtn-bills-section {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 16px 12px 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-bills-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2.5px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      color: white;
    }

    .mtn-bills-icon i {
      width: 26px;
      height: 26px;
    }

    .mtn-bills-info {
      flex: 1;
      min-width: 0;
    }

    .mtn-bills-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      line-height: 1.2;
    }

    .mtn-bills-subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-top: 4px;
    }

    /* Stats row inside header */
    .mtn-stats-row {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 12px 16px 20px 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-stat {
      text-align: center;
    }

    .mtn-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .mtn-stat-label {
      font-size: 10px;
      color: rgba(255,255,255,0.65);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .mtn-header-curve {
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 20px;
      background: #f5f5f5;
      border-radius: 20px 20px 0 0;
    }

    [data-theme="dark"] .mtn-header-curve {
      background: var(--bg-color, #1a1a2e);
    }

    .mtn-header-spacer {
      height: 260px;
    }

    body {
      padding-top: 0 !important;
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .filter-tab {
      padding: 10px 16px;
      border: none;
      background: var(--card-bg);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-tab.active {
      background: var(--primary-color);
      color: white;
    }

    .filter-tab .count {
      background: rgba(0,0,0,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
    }

    .filter-tab.active .count {
      background: rgba(255,255,255,0.2);
    }

    /* Bills List */
    .bills-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 100px;
    }

    .bill-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .bill-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .bill-card.overdue {
      border-color: #dc3545;
      background: rgba(220, 53, 69, 0.05);
    }

    .bill-card.due-soon {
      border-color: #FCD116;
      background: rgba(252, 209, 22, 0.08);
    }

    .bill-card.paid {
      border-color: var(--success-color);
      opacity: 0.7;
    }

    .bill-icon {
      width: 50px;
      height: 50px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .bill-icon.electricity { background: linear-gradient(135deg, #FCD116, #E6B800); }
    .bill-icon.water { background: linear-gradient(135deg, #00A05E, #006B3F); }
    .bill-icon.internet { background: linear-gradient(135deg, #006B3F, #004d2c); }
    .bill-icon.rent { background: linear-gradient(135deg, #004d2c, #003322); }
    .bill-icon.phone { background: linear-gradient(135deg, #00A05E, #00804A); }
    .bill-icon.insurance { background: linear-gradient(135deg, #004d2c, #002211); }
    .bill-icon.subscription { background: linear-gradient(135deg, #FCD116, #00A05E); }
    .bill-icon.loan { background: linear-gradient(135deg, #dc3545, #a71d2a); }
    .bill-icon.other { background: linear-gradient(135deg, #607D8B, #455A64); }

    .bill-details {
      flex: 1;
      min-width: 0;
    }

    .bill-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .bill-due {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bill-due.overdue {
      color: #dc3545;
      font-weight: 600;
    }

    .bill-due.due-soon {
      color: #B8960E;
      font-weight: 600;
    }

    .bill-amount {
      text-align: right;
    }

    .bill-amount-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .bill-frequency {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      opacity: 0.3;
      margin-bottom: 16px;
    }

    .empty-state p {
      font-size: 13px;
      margin-bottom: 16px;
    }

    /* Add Bill FAB */
    .add-bill-fab {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      border: none;
      box-shadow: 0 4px 20px rgba(0, 107, 63, 0.4);
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .add-bill-fab:hover {
      transform: scale(1.1);
    }

    /* Bill Category Select */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .category-option {
      padding: 14px 10px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-color);
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .category-option:hover {
      border-color: var(--primary-color);
    }

    .category-option.selected {
      border-color: var(--primary-color);
      background: rgba(0, 107, 63, 0.1);
    }

    .category-option-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .category-option-label {
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Frequency Select Pills */
    .frequency-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .frequency-pill {
      padding: 10px 16px;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      background: var(--bg-color);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .frequency-pill:hover {
      border-color: var(--primary-color);
    }

    .frequency-pill.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }

    /* Upcoming Bills Alert */
    .upcoming-alert {
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 193, 7, 0.15));
      border: 1px solid rgba(252, 209, 22, 0.3);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .upcoming-alert-icon {
      width: 40px;
      height: 40px;
      background: #FCD116;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      flex-shrink: 0;
    }

    .upcoming-alert-text {
      flex: 1;
    }

    .upcoming-alert-title {
      font-size: 13px;
      font-weight: 600;
      color: #B8960E;
      margin-bottom: 2px;
    }

    .upcoming-alert-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-badge.pending {
      background: rgba(252, 209, 22, 0.15);
      color: #B8960E;
    }

    .status-badge.overdue {
      background: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }

    .status-badge.paid {
      background: rgba(0, 160, 94, 0.15);
      color: var(--success-color);
    }

    .status-badge.due-soon {
      background: rgba(252, 209, 22, 0.15);
      color: #B8960E;
    }
  </style>
</head>
<body>
  <!-- MTN-Style Header -->
  <header class="mtn-header">
    <div class="mtn-topbar">
      <a href="dashboard.html" class="mtn-back-btn">
        <i data-lucide="arrow-left"></i>
      </a>
      <span class="mtn-page-title">Bills & Payments</span>
      <div class="mtn-topbar-spacer"></div>
    </div>

    <!-- Bills Info Section -->
    <div class="mtn-bills-section">
      <div class="mtn-bills-icon">
        <i data-lucide="calendar-clock"></i>
      </div>
      <div class="mtn-bills-info">
        <div class="mtn-bills-title">Manage Bills</div>
        <div class="mtn-bills-subtitle">Track and pay your recurring bills</div>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="mtn-stats-row">
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="totalDue">‚Çµ0</div>
        <div class="mtn-stat-label">Due This Month</div>
      </div>
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="overdueBills">0</div>
        <div class="mtn-stat-label">Overdue</div>
      </div>
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="paidBills">0</div>
        <div class="mtn-stat-label">Paid</div>
      </div>
    </div>

    <div class="mtn-header-curve"></div>
  </header>

  <!-- Header Spacer -->
  <div class="mtn-header-spacer"></div>

  <!-- Main Content -->
  <main class="main-content">

    <!-- Upcoming Alert -->
    <div class="upcoming-alert" id="upcomingAlert" style="display:none;">
      <div class="upcoming-alert-icon">
        <i data-lucide="bell" style="width:20px;height:20px"></i>
      </div>
      <div class="upcoming-alert-text">
        <div class="upcoming-alert-title" id="alertTitle">Bills Due Soon</div>
        <div class="upcoming-alert-desc" id="alertDesc">You have bills due in the next 3 days</div>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="filterBills('all')" id="filterAll">
        All <span class="count" id="countAll">0</span>
      </button>
      <button class="filter-tab" onclick="filterBills('upcoming')" id="filterUpcoming">
        <i data-lucide="clock" style="width:14px;height:14px"></i> Upcoming
      </button>
      <button class="filter-tab" onclick="filterBills('overdue')" id="filterOverdue">
        <i data-lucide="alert-circle" style="width:14px;height:14px"></i> Overdue
      </button>
      <button class="filter-tab" onclick="filterBills('paid')" id="filterPaid">
        <i data-lucide="check-circle" style="width:14px;height:14px"></i> Paid
      </button>
    </div>

    <!-- Bills List -->
    <div class="bills-list" id="billsList">
      <div class="empty-state">
        <i data-lucide="file-text" style="width:48px;height:48px"></i>
        <p>No bills added yet.<br>Tap + to add your first bill.</p>
        <button class="btn btn-primary" onclick="openBillModal()">Add Bill</button>
      </div>
    </div>
  </main>

  <!-- Add Bill FAB -->
  <button class="add-bill-fab" onclick="openBillModal()" title="Add Bill">
    <i data-lucide="plus" style="width:24px;height:24px"></i>
  </button>


  <!-- Add/Edit Bill Modal -->
  <div id="billModal" class="modal">
    <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title" id="billModalTitle">Add New Bill</h2>
        <button class="close-btn" onclick="closeModal('billModal')">&times;</button>
      </div>
      <form id="billForm" onsubmit="handleSaveBill(event)">
        <input type="hidden" id="billId">
        
        <!-- Category Selection -->
        <div class="form-group">
          <label class="form-label">Category</label>
          <div class="category-grid">
            <div class="category-option" data-category="electricity" onclick="selectCategory('electricity')">
              <div class="category-option-icon">‚ö°</div>
              <div class="category-option-label">Electricity</div>
            </div>
            <div class="category-option" data-category="water" onclick="selectCategory('water')">
              <div class="category-option-icon">üíß</div>
              <div class="category-option-label">Water</div>
            </div>
            <div class="category-option" data-category="internet" onclick="selectCategory('internet')">
              <div class="category-option-icon">üì∂</div>
              <div class="category-option-label">Internet</div>
            </div>
            <div class="category-option" data-category="rent" onclick="selectCategory('rent')">
              <div class="category-option-icon">üè†</div>
              <div class="category-option-label">Rent</div>
            </div>
            <div class="category-option" data-category="phone" onclick="selectCategory('phone')">
              <div class="category-option-icon">üì±</div>
              <div class="category-option-label">Phone</div>
            </div>
            <div class="category-option" data-category="insurance" onclick="selectCategory('insurance')">
              <div class="category-option-icon">üõ°Ô∏è</div>
              <div class="category-option-label">Insurance</div>
            </div>
            <div class="category-option" data-category="subscription" onclick="selectCategory('subscription')">
              <div class="category-option-icon">üì∫</div>
              <div class="category-option-label">Subscription</div>
            </div>
            <div class="category-option" data-category="loan" onclick="selectCategory('loan')">
              <div class="category-option-icon">üí∞</div>
              <div class="category-option-label">Loan</div>
            </div>
            <div class="category-option" data-category="other" onclick="selectCategory('other')">
              <div class="category-option-icon">üìã</div>
              <div class="category-option-label">Other</div>
            </div>
          </div>
          <input type="hidden" id="billCategory" required>
        </div>

        <div class="form-group">
          <label class="form-label">Bill Name</label>
          <input type="text" class="form-input" id="billName" placeholder="e.g., ECG Monthly" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Amount</label>
            <div class="currency-input-wrapper">
              <span class="currency-prefix" id="currencyPrefix">‚Çµ</span>
              <input type="number" class="form-input has-prefix" id="billAmount" placeholder="0.00" step="0.01" min="0.01" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-input" id="billDueDate" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Frequency</label>
          <div class="frequency-pills">
            <button type="button" class="frequency-pill" data-freq="once" onclick="selectFrequency('once')">Once</button>
            <button type="button" class="frequency-pill selected" data-freq="monthly" onclick="selectFrequency('monthly')">Monthly</button>
            <button type="button" class="frequency-pill" data-freq="quarterly" onclick="selectFrequency('quarterly')">Quarterly</button>
            <button type="button" class="frequency-pill" data-freq="yearly" onclick="selectFrequency('yearly')">Yearly</button>
          </div>
          <input type="hidden" id="billFrequency" value="monthly">
        </div>

        <div class="form-group">
          <label class="form-label">Notes (Optional)</label>
          <textarea class="form-textarea" id="billNotes" rows="2" placeholder="Add any notes..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;" id="saveBillBtn">Add Bill</button>
      </form>
    </div>
  </div>

  <!-- Bill Details Modal -->
  <div id="billDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Bill Details</h2>
        <button class="close-btn" onclick="closeModal('billDetailsModal')">&times;</button>
      </div>
      <div id="billDetailsContent"></div>
    </div>
  </div>

  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script>
    utils.requireAuth();
    lucide.createIcons();

    let bills = JSON.parse(localStorage.getItem('kudipal_bills')) || [];
    let currentFilter = 'all';
    let selectedCategory = '';
    let selectedFrequency = 'monthly';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set currency prefix
      const prefix = document.getElementById('currencyPrefix');
      if (prefix) prefix.textContent = utils.getCurrencySymbol();
      
      renderBills();
      updateSummary();
      checkUpcomingBills();
    });

    function openBillModal(billId = null) {
      const modal = document.getElementById('billModal');
      const form = document.getElementById('billForm');
      const title = document.getElementById('billModalTitle');
      const btn = document.getElementById('saveBillBtn');
      
      form.reset();
      document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
      document.querySelectorAll('.frequency-pill').forEach(el => el.classList.remove('selected'));
      document.querySelector('.frequency-pill[data-freq="monthly"]').classList.add('selected');
      
      selectedCategory = '';
      selectedFrequency = 'monthly';
      document.getElementById('billFrequency').value = 'monthly';

      if (billId) {
        const bill = bills.find(b => b.id === billId);
        if (bill) {
          title.textContent = 'Edit Bill';
          btn.textContent = 'Update Bill';
          document.getElementById('billId').value = bill.id;
          document.getElementById('billName').value = bill.name;
          document.getElementById('billAmount').value = bill.amount;
          document.getElementById('billDueDate').value = bill.dueDate;
          document.getElementById('billNotes').value = bill.notes || '';
          selectCategory(bill.category);
          selectFrequency(bill.frequency);
        }
      } else {
        title.textContent = 'Add New Bill';
        btn.textContent = 'Add Bill';
        document.getElementById('billId').value = '';
        // Set default due date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('billDueDate').value = tomorrow.toISOString().split('T')[0];
      }

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      lucide.createIcons({ node: modal });
    }

    function selectCategory(category) {
      document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.category-option[data-category="${category}"]`).classList.add('selected');
      document.getElementById('billCategory').value = category;
      selectedCategory = category;
    }

    function selectFrequency(freq) {
      document.querySelectorAll('.frequency-pill').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.frequency-pill[data-freq="${freq}"]`).classList.add('selected');
      document.getElementById('billFrequency').value = freq;
      selectedFrequency = freq;
    }

    function handleSaveBill(e) {
      e.preventDefault();
      
      if (!selectedCategory) {
        utils.showAlert('Please select a category', 'warning');
        return;
      }

      const billId = document.getElementById('billId').value;
      const bill = {
        id: billId || Date.now().toString(),
        name: document.getElementById('billName').value,
        amount: parseFloat(document.getElementById('billAmount').value),
        dueDate: document.getElementById('billDueDate').value,
        category: selectedCategory,
        frequency: selectedFrequency,
        notes: document.getElementById('billNotes').value,
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      if (billId) {
        const index = bills.findIndex(b => b.id === billId);
        if (index !== -1) {
          bill.status = bills[index].status;
          bills[index] = bill;
        }
        utils.showAlert('Bill updated!', 'success');
      } else {
        bills.push(bill);
        utils.showAlert('Bill added!', 'success');
      }

      localStorage.setItem('kudipal_bills', JSON.stringify(bills));
      closeModal('billModal');
      renderBills();
      updateSummary();
      checkUpcomingBills();
    }

    function filterBills(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active'));
      document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
      renderBills();
    }

    function getBillStatus(bill) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueDate = new Date(bill.dueDate);
      dueDate.setHours(0, 0, 0, 0);
      
      if (bill.status === 'paid') return 'paid';
      if (dueDate < today) return 'overdue';
      
      const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
      if (diffDays <= 3) return 'due-soon';
      
      return 'pending';
    }

    function getDaysUntilDue(dueDate) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dueDate);
      due.setHours(0, 0, 0, 0);
      return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
    }

    function renderBills() {
      const container = document.getElementById('billsList');
      
      let filteredBills = [...bills];
      
      // Apply filter
      if (currentFilter === 'upcoming') {
        filteredBills = bills.filter(b => {
          const status = getBillStatus(b);
          return status === 'pending' || status === 'due-soon';
        });
      } else if (currentFilter === 'overdue') {
        filteredBills = bills.filter(b => getBillStatus(b) === 'overdue');
      } else if (currentFilter === 'paid') {
        filteredBills = bills.filter(b => b.status === 'paid');
      }

      // Sort by due date
      filteredBills.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      // Update counts
      document.getElementById('countAll').textContent = bills.length;

      if (filteredBills.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i data-lucide="file-text" style="width:48px;height:48px"></i>
            <p>${currentFilter === 'all' ? 'No bills added yet.<br>Tap + to add your first bill.' : 'No bills in this category.'}</p>
            ${currentFilter === 'all' ? '<button class="btn btn-primary" onclick="openBillModal()">Add Bill</button>' : ''}
          </div>
        `;
        lucide.createIcons({ node: container });
        return;
      }

      const categoryIcons = {
        electricity: '‚ö°',
        water: 'üíß',
        internet: 'üì∂',
        rent: 'üè†',
        phone: 'üì±',
        insurance: 'üõ°Ô∏è',
        subscription: 'üì∫',
        loan: 'üí∞',
        other: 'üìã'
      };

      container.innerHTML = filteredBills.map(bill => {
        const status = getBillStatus(bill);
        const daysUntil = getDaysUntilDue(bill.dueDate);
        let dueText = '';
        
        if (status === 'paid') {
          dueText = 'Paid';
        } else if (status === 'overdue') {
          dueText = `Overdue by ${Math.abs(daysUntil)} day${Math.abs(daysUntil) !== 1 ? 's' : ''}`;
        } else if (daysUntil === 0) {
          dueText = 'Due today!';
        } else if (daysUntil === 1) {
          dueText = 'Due tomorrow';
        } else {
          dueText = `Due in ${daysUntil} days`;
        }

        return `
          <div class="bill-card ${status}" onclick="showBillDetails('${bill.id}')">
            <div class="bill-icon ${bill.category}">${categoryIcons[bill.category] || 'üìã'}</div>
            <div class="bill-details">
              <div class="bill-name">${bill.name}</div>
              <div class="bill-due ${status}">
                <i data-lucide="calendar" style="width:12px;height:12px"></i>
                ${dueText}
              </div>
            </div>
            <div class="bill-amount">
              <div class="bill-amount-value">${utils.formatCurrency(bill.amount)}</div>
              <div class="bill-frequency">${bill.frequency}</div>
            </div>
          </div>
        `;
      }).join('');

      lucide.createIcons({ node: container });
    }

    function showBillDetails(billId) {
      const bill = bills.find(b => b.id === billId);
      if (!bill) return;

      const status = getBillStatus(bill);
      const daysUntil = getDaysUntilDue(bill.dueDate);

      const categoryIcons = {
        electricity: '‚ö°',
        water: 'üíß',
        internet: 'üì∂',
        rent: 'üè†',
        phone: 'üì±',
        insurance: 'üõ°Ô∏è',
        subscription: 'üì∫',
        loan: 'üí∞',
        other: 'üìã'
      };

      const content = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div class="bill-icon ${bill.category}" style="width:70px;height:70px;font-size:32px;margin:0 auto 12px;">
            ${categoryIcons[bill.category] || 'üìã'}
          </div>
          <h3 style="font-size:18px;color:var(--text-primary);margin-bottom:4px;">${bill.name}</h3>
          <span class="status-badge ${status}">${status === 'due-soon' ? 'Due Soon' : status}</span>
        </div>
        
        <div style="background:var(--bg-color);border-radius:12px;padding:16px;margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span style="color:var(--text-muted);font-size:12px;">Amount</span>
            <span style="font-weight:700;font-size:18px;color:var(--text-primary);">${utils.formatCurrency(bill.amount)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span style="color:var(--text-muted);font-size:12px;">Due Date</span>
            <span style="font-weight:600;font-size:13px;color:var(--text-primary);">${new Date(bill.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span style="color:var(--text-muted);font-size:12px;">Frequency</span>
            <span style="font-weight:600;font-size:13px;color:var(--text-primary);text-transform:capitalize;">${bill.frequency}</span>
          </div>
          ${bill.notes ? `
          <div style="border-top:1px solid var(--border-color);padding-top:12px;margin-top:12px;">
            <span style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:4px;">Notes</span>
            <span style="font-size:13px;color:var(--text-primary);">${bill.notes}</span>
          </div>
          ` : ''}
        </div>

        <div style="display:flex;gap:10px;">
          ${bill.status !== 'paid' ? `
          <button class="btn btn-success" style="flex:1;" onclick="markAsPaid('${bill.id}')">
            <i data-lucide="check" style="width:16px;height:16px;margin-right:6px"></i> Mark as Paid
          </button>
          ` : `
          <button class="btn" style="flex:1;background:var(--bg-color);color:var(--text-primary);" onclick="markAsUnpaid('${bill.id}')">
            <i data-lucide="rotate-ccw" style="width:16px;height:16px;margin-right:6px"></i> Mark as Unpaid
          </button>
          `}
          <button class="btn" style="background:var(--bg-color);color:var(--text-primary);padding:12px;" onclick="editBill('${bill.id}')">
            <i data-lucide="edit-2" style="width:16px;height:16px"></i>
          </button>
          <button class="btn" style="background:rgba(220,53,69,0.1);color:#dc3545;padding:12px;" onclick="deleteBill('${bill.id}')">
            <i data-lucide="trash-2" style="width:16px;height:16px"></i>
          </button>
        </div>
      `;

      document.getElementById('billDetailsContent').innerHTML = content;
      document.getElementById('billDetailsModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      const detailsContent = document.getElementById('billDetailsContent');
      if (detailsContent) lucide.createIcons({ node: detailsContent });
    }

    function markAsPaid(billId) {
      const index = bills.findIndex(b => b.id === billId);
      if (index !== -1) {
        bills[index].status = 'paid';
        bills[index].paidDate = new Date().toISOString();
        localStorage.setItem('kudipal_bills', JSON.stringify(bills));
        closeModal('billDetailsModal');
        renderBills();
        updateSummary();
        utils.showAlert('Bill marked as paid! üéâ', 'success');
      }
    }

    function markAsUnpaid(billId) {
      const index = bills.findIndex(b => b.id === billId);
      if (index !== -1) {
        bills[index].status = 'pending';
        delete bills[index].paidDate;
        localStorage.setItem('kudipal_bills', JSON.stringify(bills));
        closeModal('billDetailsModal');
        renderBills();
        updateSummary();
        utils.showAlert('Bill marked as unpaid', 'info');
      }
    }

    function editBill(billId) {
      closeModal('billDetailsModal');
      setTimeout(() => openBillModal(billId), 300);
    }

    function deleteBill(billId) {
      if (confirm('Are you sure you want to delete this bill?')) {
        bills = bills.filter(b => b.id !== billId);
        localStorage.setItem('kudipal_bills', JSON.stringify(bills));
        closeModal('billDetailsModal');
        renderBills();
        updateSummary();
        utils.showAlert('Bill deleted', 'info');
      }
    }

    function updateSummary() {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const thisMonthBills = bills.filter(b => {
        const due = new Date(b.dueDate);
        return due.getMonth() === currentMonth && due.getFullYear() === currentYear;
      });

      const totalDue = thisMonthBills
        .filter(b => b.status !== 'paid')
        .reduce((sum, b) => sum + b.amount, 0);

      const overdue = bills.filter(b => getBillStatus(b) === 'overdue').length;
      const paid = thisMonthBills.filter(b => b.status === 'paid').length;

      document.getElementById('totalDue').textContent = utils.formatCurrency(totalDue);
      document.getElementById('overdueBills').textContent = overdue;
      document.getElementById('paidBills').textContent = paid;
    }

    function checkUpcomingBills() {
      const upcomingBills = bills.filter(b => {
        const status = getBillStatus(b);
        return status === 'due-soon' || status === 'overdue';
      });

      const alertDiv = document.getElementById('upcomingAlert');
      
      if (upcomingBills.length > 0) {
        const overdueBills = upcomingBills.filter(b => getBillStatus(b) === 'overdue');
        
        if (overdueBills.length > 0) {
          document.getElementById('alertTitle').textContent = `${overdueBills.length} Overdue Bill${overdueBills.length > 1 ? 's' : ''}!`;
          document.getElementById('alertDesc').textContent = `Total: ${utils.formatCurrency(overdueBills.reduce((sum, b) => sum + b.amount, 0))}`;
          alertDiv.style.background = 'linear-gradient(135deg, rgba(220, 53, 69, 0.15), rgba(239, 83, 80, 0.15))';
          alertDiv.style.borderColor = 'rgba(220, 53, 69, 0.3)';
          alertDiv.querySelector('.upcoming-alert-icon').style.background = '#dc3545';
          alertDiv.querySelector('.upcoming-alert-title').style.color = '#dc3545';
        } else {
          document.getElementById('alertTitle').textContent = `${upcomingBills.length} Bill${upcomingBills.length > 1 ? 's' : ''} Due Soon`;
          document.getElementById('alertDesc').textContent = `Don't forget to pay on time!`;
        }
        
        alertDiv.style.display = 'flex';
      } else {
        alertDiv.style.display = 'none';
      }
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      document.body.style.overflow = '';
    }

    // Backdrop click to close modals
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '../index.html';
    }
  </script>
</body>
</html>