<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#006B3F">
  <title>Savings Challenges - KudiSave</title>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* ===== Modern Header for Challenges ===== */
    .mtn-header {
      background: linear-gradient(160deg, var(--primary-color) 0%, #004d2c 40%, #003822 80%, #002a19 100%);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding-top: env(safe-area-inset-top, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      overflow: hidden;
    }

    .mtn-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%;
    }

    .mtn-header::after {
      content: '';
      position: absolute;
      bottom: -40%;
      left: -15%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
      border-radius: 50%;
    }

    .mtn-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px 0 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-back-btn {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
    }

    .mtn-back-btn:active {
      transform: scale(0.92);
      background: rgba(255,255,255,0.18);
    }

    .mtn-back-btn i {
      width: 18px;
      height: 18px;
    }

    .mtn-page-title {
      font-size: 17px;
      font-weight: 700;
      color: white;
      letter-spacing: -0.3px;
    }

    .mtn-topbar-spacer {
      width: 38px;
    }

    /* Challenge info section inside header */
    .mtn-challenge-section {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 16px 12px 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-challenge-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      border: 1px solid rgba(255,255,255,0.15);
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .mtn-challenge-info {
      flex: 1;
      min-width: 0;
    }

    .mtn-challenge-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      line-height: 1.2;
    }

    .mtn-challenge-xp {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.15);
      padding: 4px 12px;
      border-radius: 20px;
      margin-top: 6px;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }

    /* Stats row inside header */
    .mtn-stats-row {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 12px 16px 20px 16px;
      position: relative;
      z-index: 1;
    }

    .mtn-stat {
      text-align: center;
    }

    .mtn-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .mtn-stat-label {
      font-size: 10px;
      color: rgba(255,255,255,0.65);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .mtn-header-curve {
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 24px;
      background: var(--bg-primary, #f5f6fa);
      border-radius: 24px 24px 0 0;
    }

    [data-theme="dark"] .mtn-header-curve {
      background: var(--bg-primary, #0f172a);
    }

    .mtn-header-spacer {
      height: 270px;
    }

    body {
      padding-top: 0 !important;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Section Title */
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Challenge Cards */
    .active-challenges {
      margin-bottom: 20px;
    }

    .challenge-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .challenge-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), #00c853, #FFD700);
      background-size: 200% 100%;
      animation: progressGradient 3s ease infinite;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .challenge-card:hover::before {
      opacity: 1;
    }

    .challenge-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border-color: var(--primary-color);
    }

    .challenge-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .challenge-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .challenge-icon.easy { background: rgba(76, 175, 80, 0.1); }
    .challenge-icon.medium { background: rgba(255, 152, 0, 0.1); }
    .challenge-icon.hard { background: rgba(233, 30, 99, 0.1); }
    .challenge-icon.extreme { background: rgba(156, 39, 176, 0.1); }

    .challenge-info {
      flex: 1;
      margin-left: 12px;
    }

    .challenge-name {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .challenge-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .xp-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(252, 209, 22, 0.15);
      color: #B8960E;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .challenge-meta {
      display: flex;
      gap: 12px;
      margin: 12px 0;
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .difficulty-badge {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .difficulty-badge.easy { background: rgba(0, 160, 94, 0.1); color: #006B3F; }
    .difficulty-badge.medium { background: rgba(252, 209, 22, 0.15); color: #B8960E; }
    .difficulty-badge.hard { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .difficulty-badge.extreme { background: rgba(0, 77, 44, 0.15); color: #004d2c; }

    .progress-section {
      margin-top: 14px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .progress-label {
      color: var(--text-muted);
    }

    .progress-value {
      font-weight: 700;
      color: var(--primary-color);
    }

    .progress-bar {
      height: 12px;
      background: linear-gradient(145deg, var(--border-color), rgba(255,255,255,0.05));
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 1px 2px rgba(255,255,255,0.05);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, #00c853 50%, #FFD700 100%);
      background-size: 200% 100%;
      animation: progressGradient 3s ease infinite;
      border-radius: 8px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 10px rgba(0, 160, 94, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes progressGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .challenge-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .challenge-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-color);
      color: var(--text-secondary);
    }

    .btn-danger {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }

    /* Available Challenges Grid */
    .available-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding-bottom: 100px;
    }

    .available-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .available-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    .available-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .available-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .available-xp {
      font-size: 11px;
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      opacity: 0.3;
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      width: 100%;
      max-width: 400px;
      border-radius: 20px;
      padding: 24px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      line-height: 1;
    }

    .modal-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 12px;
    }

    .modal-desc {
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .modal-xp {
      background: linear-gradient(135deg, var(--primary-color), #00A05E);
      color: white;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
    }

    .modal-xp-label {
      font-size: 11px;
      opacity: 0.9;
    }

    .modal-xp-value {
      font-size: 24px;
      font-weight: 700;
    }

    /* FAB Button */
    .fab-btn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #006B3F, #00A05E);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 107, 63, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .fab-btn:hover {
      transform: scale(1.1);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 14px;
      background: var(--bg-color);
      color: var(--text-primary);
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .form-btn.primary {
      background: var(--primary-color);
      color: white;
    }

    .form-btn.secondary {
      background: var(--bg-color);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- MTN-Style Header -->
  <header class="mtn-header">
    <div class="mtn-topbar">
      <a href="dashboard.html" class="mtn-back-btn">
        <i data-lucide="arrow-left"></i>
      </a>
      <span class="mtn-page-title">Savings Challenges</span>
      <div class="mtn-topbar-spacer"></div>
    </div>

    <!-- Challenge Info Section -->
    <div class="mtn-challenge-section">
      <div class="mtn-challenge-icon">≡ƒÅå</div>
      <div class="mtn-challenge-info">
        <div class="mtn-challenge-title">Challenges</div>
        <div class="mtn-challenge-xp">
          ΓÜí <span id="totalXP">0</span> XP Earned
        </div>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="mtn-stats-row">
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="completedCount">0</div>
        <div class="mtn-stat-label">Completed</div>
      </div>
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="activeCount">0</div>
        <div class="mtn-stat-label">Active</div>
      </div>
      <div class="mtn-stat">
        <div class="mtn-stat-value" id="availableCount">0</div>
        <div class="mtn-stat-label">Available</div>
      </div>
    </div>

    <div class="mtn-header-curve"></div>
  </header>

  <!-- Header Spacer -->
  <div class="mtn-header-spacer"></div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Active Challenges Section -->
    <div class="section-title">≡ƒöÑ Active Challenges</div>
    <div class="active-challenges" id="activeChallenges">
      <!-- Rendered dynamically -->
    </div>

    <!-- Available Challenges Section -->
    <div class="section-title">Γ£¿ Available Challenges</div>
    <div class="available-grid" id="availableChallenges">
      <!-- Rendered dynamically -->
    </div>
  </main>

  <!-- FAB Button -->
  <button class="fab-btn" onclick="openAddModal()" title="Create Custom Challenge">
    <i data-lucide="plus" style="width:24px;height:24px"></i>
  </button>

  <!-- Challenge Detail Modal -->
  <div id="challengeModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="modal-header" style="justify-content: flex-end;">
        <button class="close-btn" onclick="closeModal('challengeModal')">&times;</button>
      </div>
      <div class="modal-icon" id="modalIcon">≡ƒÄ»</div>
      <h2 class="modal-title" id="modalTitle">Challenge Name</h2>
      <p class="modal-desc" id="modalDesc">Challenge description goes here with details about what you need to do.</p>
      
      <div class="modal-xp">
        <div class="modal-xp-label">Reward</div>
        <div class="modal-xp-value" id="modalXP">+100 XP</div>
      </div>
      
      <div class="challenge-meta" style="justify-content: center; margin-bottom: 16px;">
        <span class="difficulty-badge medium" id="modalDifficulty">Medium</span>
        <span class="meta-item" id="modalDuration">≡ƒôà 30 days</span>
        <span class="meta-item" id="modalTarget">≡ƒÄ» Target: Γé╡500</span>
      </div>
      
      <div class="challenge-actions">
        <button class="challenge-btn btn-secondary" onclick="closeModal('challengeModal')">Cancel</button>
        <button class="challenge-btn btn-primary" id="joinBtn" onclick="joinChallenge()">Start Challenge</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Challenge Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Challenge</h2>
        <button class="close-btn" onclick="closeModal('addModal')">&times;</button>
      </div>
      <form id="challengeForm" onsubmit="saveChallenge(event)">
        <div class="form-group">
          <label class="form-label">Challenge Name</label>
          <input type="text" class="form-input" id="challengeName" placeholder="e.g., No-Spend Weekend" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="challengeDesc" placeholder="Describe the challenge..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select class="form-select" id="challengeType">
              <option value="savings">≡ƒÆ░ Savings</option>
              <option value="no-spend">≡ƒÜ½ No-Spend</option>
              <option value="budget">≡ƒôè Budget</option>
              <option value="streak">≡ƒöÑ Streak</option>
              <option value="goal">≡ƒÄ» Goal</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Difficulty</label>
            <select class="form-select" id="challengeDifficulty">
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Target Value (Γé╡)</label>
            <input type="number" class="form-input" id="challengeTarget" placeholder="500" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Duration (days)</label>
            <input type="number" class="form-input" id="challengeDuration" placeholder="30" min="1" value="30">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">XP Reward</label>
          <input type="number" class="form-input" id="challengeXP" placeholder="100" min="10" value="100">
        </div>
        <button type="submit" class="form-btn primary">Create Challenge</button>
        <button type="button" class="form-btn secondary" onclick="closeModal('addModal')">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Progress Update Modal -->
  <div id="progressModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div class="modal-header">
        <h2 class="modal-title">Update Progress</h2>
        <button class="close-btn" onclick="closeModal('progressModal')">&times;</button>
      </div>
      <p id="progressChallengeTitle" style="color: var(--text-muted); margin-bottom: 16px;">Challenge Name</p>
      <div class="form-group">
        <label class="form-label">Progress Amount</label>
        <input type="number" class="form-input" id="progressAmount" placeholder="Enter amount" min="0" step="0.01">
      </div>
      <div class="challenge-actions">
        <button class="challenge-btn btn-secondary" onclick="closeModal('progressModal')">Cancel</button>
        <button class="challenge-btn btn-primary" onclick="submitProgress()">Update</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script>
    utils.requireAuth();
    lucide.createIcons();

    // Challenge icons mapping
    const challengeIcons = {
      'no-spend': '≡ƒÜ½',
      'savings': '≡ƒÆ░',
      'budget': '≡ƒôè',
      'streak': '≡ƒöÑ',
      'goal': '≡ƒÄ»',
      'default': 'Γ¡É'
    };

    // Default challenges
    const defaultChallenges = [
      { id: 1, name: 'No-Spend Day', type: 'no-spend', description: 'Go 24 hours without spending any money', difficulty: 'easy', target: 1, duration: 1, xp: 50 },
      { id: 2, name: 'Save Γé╡100', type: 'savings', description: 'Save at least Γé╡100 this week', difficulty: 'easy', target: 100, duration: 7, xp: 100 },
      { id: 3, name: 'Budget Master', type: 'budget', description: 'Stay under budget for all categories this month', difficulty: 'medium', target: 30, duration: 30, xp: 300 },
      { id: 4, name: '7-Day Streak', type: 'streak', description: 'Track expenses for 7 days straight', difficulty: 'easy', target: 7, duration: 7, xp: 75 },
      { id: 5, name: 'Weekend Warrior', type: 'no-spend', description: 'No spending on Saturday and Sunday', difficulty: 'medium', target: 2, duration: 2, xp: 150 },
      { id: 6, name: 'Save Γé╡500', type: 'savings', description: 'Save Γé╡500 in one month', difficulty: 'medium', target: 500, duration: 30, xp: 250 },
      { id: 7, name: '30-Day Tracker', type: 'streak', description: 'Track every expense for 30 days', difficulty: 'hard', target: 30, duration: 30, xp: 400 },
      { id: 8, name: 'Save Γé╡1000', type: 'savings', description: 'Save Γé╡1000 in two months', difficulty: 'hard', target: 1000, duration: 60, xp: 500 },
      { id: 9, name: 'Super Saver', type: 'savings', description: 'Save Γé╡5000 in 6 months', difficulty: 'extreme', target: 5000, duration: 180, xp: 1000 },
      { id: 10, name: 'No Coffee Week', type: 'no-spend', description: 'Skip buying coffee for a week', difficulty: 'easy', target: 7, duration: 7, xp: 60 }
    ];

    // State
    let challenges = [];
    let activeChallenges = [];
    let selectedChallenge = null;
    let currentProgressChallenge = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadChallenges();
      lucide.createIcons();
    });

    function loadChallenges() {
      // Load from localStorage
      let storedChallenges = JSON.parse(localStorage.getItem('kudisave_challenges')) || [];
      let storedActive = JSON.parse(localStorage.getItem('kudisave_active_challenges')) || [];

      // Merge with defaults
      challenges = [...defaultChallenges];
      storedChallenges.forEach(sc => {
        if (!challenges.find(c => c.id === sc.id)) {
          challenges.push(sc);
        }
      });

      activeChallenges = storedActive;

      // Update stats from badges data
      const badgesData = JSON.parse(localStorage.getItem('kudisave_badges')) || { xp: 0 };
      document.getElementById('totalXP').textContent = badgesData.xp || 0;

      updateStats();
      renderActiveChallenges();
      renderAvailableChallenges();
    }

    function updateStats() {
      const completed = activeChallenges.filter(c => c.status === 'completed').length;
      const active = activeChallenges.filter(c => c.status === 'active').length;
      const activeIds = activeChallenges.map(c => c.challengeId);
      const available = challenges.filter(c => !activeIds.includes(c.id)).length;

      document.getElementById('completedCount').textContent = completed;
      document.getElementById('activeCount').textContent = active;
      document.getElementById('availableCount').textContent = available;
    }

    function renderActiveChallenges() {
      const container = document.getElementById('activeChallenges');
      const active = activeChallenges.filter(c => c.status === 'active');

      if (active.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i data-lucide="flame" style="width:48px;height:48px"></i>
            <p>No active challenges.<br>Start one from below!</p>
          </div>
        `;
        const activeEl = document.getElementById('activeChallenges');
        if (activeEl) lucide.createIcons({ node: activeEl });
        return;
      }

      container.innerHTML = active.map(ac => {
        const challenge = challenges.find(c => c.id === ac.challengeId) || {};
        const progress = challenge.target > 0 ? (ac.progress / challenge.target) * 100 : 0;
        const daysLeft = Math.max(0, Math.ceil((new Date(ac.endDate) - new Date()) / (1000 * 60 * 60 * 24)));

        return `
          <div class="challenge-card">
            <div class="challenge-header">
              <div class="challenge-icon ${challenge.difficulty || 'easy'}">
                ${challengeIcons[challenge.type] || 'Γ¡É'}
              </div>
              <div class="challenge-info">
                <div class="challenge-name">${escapeHtml(challenge.name || 'Unknown')}</div>
                <div class="challenge-desc">${escapeHtml(challenge.description || '')}</div>
              </div>
              <span class="xp-badge">+${challenge.xp || 0} XP</span>
            </div>
            
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">Progress</span>
                <span class="progress-value">${ac.progress || 0}/${challenge.target || 0}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(100, progress)}%"></div>
              </div>
            </div>

            <div class="challenge-meta">
              <span class="difficulty-badge ${challenge.difficulty || 'easy'}">${challenge.difficulty || 'easy'}</span>
              <span class="meta-item">≡ƒôà ${daysLeft} days left</span>
            </div>

            <div class="challenge-actions">
              <button class="challenge-btn btn-secondary" onclick="openProgressModal('${ac.id}')">
                Log Progress
              </button>
              <button class="challenge-btn btn-danger" onclick="abandonChallenge('${ac.id}')">
                Abandon
              </button>
            </div>
          </div>
        `;
      }).join('');
      lucide.createIcons({ node: container });
    }

    function renderAvailableChallenges() {
      const container = document.getElementById('availableChallenges');
      const activeIds = activeChallenges.map(c => c.challengeId);
      const available = challenges.filter(c => !activeIds.includes(c.id));

      if (available.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: span 2;">
            <i data-lucide="check-circle" style="width:48px;height:48px"></i>
            <p>You've joined all available challenges!<br>Create a custom one.</p>
          </div>
        `;
        lucide.createIcons({ node: container });
        return;
      }

      container.innerHTML = available.map(challenge => `
        <div class="available-card" onclick="showChallengeDetail(${challenge.id})">
          <div class="available-icon">${challengeIcons[challenge.type] || 'Γ¡É'}</div>
          <div class="available-name">${escapeHtml(challenge.name)}</div>
          <div class="available-xp">+${challenge.xp} XP</div>
          <span class="difficulty-badge ${challenge.difficulty}">${challenge.difficulty}</span>
        </div>
      `).join('');
      lucide.createIcons({ node: container });
    }

    function showChallengeDetail(id) {
      selectedChallenge = challenges.find(c => c.id === id);
      if (!selectedChallenge) return;

      document.getElementById('modalIcon').textContent = challengeIcons[selectedChallenge.type] || 'Γ¡É';
      document.getElementById('modalTitle').textContent = selectedChallenge.name;
      document.getElementById('modalDesc').textContent = selectedChallenge.description;
      document.getElementById('modalXP').textContent = `+${selectedChallenge.xp} XP`;
      document.getElementById('modalDifficulty').textContent = selectedChallenge.difficulty;
      document.getElementById('modalDifficulty').className = `difficulty-badge ${selectedChallenge.difficulty}`;
      document.getElementById('modalDuration').textContent = `≡ƒôà ${selectedChallenge.duration} days`;
      document.getElementById('modalTarget').textContent = `≡ƒÄ» Target: ${selectedChallenge.type === 'savings' ? 'Γé╡' : ''}${selectedChallenge.target}`;

      document.getElementById('challengeModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function joinChallenge() {
      if (!selectedChallenge) return;

      const startDate = new Date();
      const endDate = new Date();
      endDate.setDate(endDate.getDate() + selectedChallenge.duration);

      const activeChallenge = {
        id: Date.now().toString(),
        challengeId: selectedChallenge.id,
        progress: 0,
        status: 'active',
        startDate: startDate.toISOString(),
        endDate: endDate.toISOString()
      };

      activeChallenges.push(activeChallenge);
      localStorage.setItem('kudisave_active_challenges', JSON.stringify(activeChallenges));

      closeModal('challengeModal');
      loadChallenges();
      showToast('Challenge started! Good luck!');
    }

    function openProgressModal(id) {
      currentProgressChallenge = activeChallenges.find(c => c.id === id);
      if (!currentProgressChallenge) return;

      const challenge = challenges.find(c => c.id === currentProgressChallenge.challengeId);
      document.getElementById('progressChallengeTitle').textContent = challenge?.name || 'Challenge';
      document.getElementById('progressAmount').value = '';

      document.getElementById('progressModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function submitProgress() {
      if (!currentProgressChallenge) return;

      const amount = parseFloat(document.getElementById('progressAmount').value);
      if (isNaN(amount) || amount < 0) {
        showToast('Please enter a valid amount', 'error');
        return;
      }

      const challenge = challenges.find(c => c.id === currentProgressChallenge.challengeId);
      currentProgressChallenge.progress += amount;

      // Check if completed
      if (currentProgressChallenge.progress >= (challenge?.target || 0)) {
        currentProgressChallenge.status = 'completed';
        currentProgressChallenge.completedDate = new Date().toISOString();

        // Award XP
        const badgesData = JSON.parse(localStorage.getItem('kudisave_badges')) || { xp: 0, unlocked: [], recentUnlocks: [] };
        badgesData.xp += challenge?.xp || 0;
        localStorage.setItem('kudisave_badges', JSON.stringify(badgesData));

        showToast(`≡ƒÄë Challenge completed! +${challenge?.xp || 0} XP`);
      } else {
        showToast('Progress updated!');
      }

      localStorage.setItem('kudisave_active_challenges', JSON.stringify(activeChallenges));
      closeModal('progressModal');
      loadChallenges();
      currentProgressChallenge = null;
    }

    function abandonChallenge(id) {
      if (!confirm('Are you sure you want to abandon this challenge?')) return;

      activeChallenges = activeChallenges.filter(c => c.id !== id);
      localStorage.setItem('kudisave_active_challenges', JSON.stringify(activeChallenges));
      loadChallenges();
      showToast('Challenge abandoned');
    }

    function openAddModal() {
      document.getElementById('challengeForm').reset();
      document.getElementById('addModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function saveChallenge(e) {
      e.preventDefault();

      const newChallenge = {
        id: Date.now(),
        name: document.getElementById('challengeName').value,
        description: document.getElementById('challengeDesc').value,
        type: document.getElementById('challengeType').value,
        difficulty: document.getElementById('challengeDifficulty').value,
        target: parseInt(document.getElementById('challengeTarget').value) || 1,
        duration: parseInt(document.getElementById('challengeDuration').value) || 30,
        xp: parseInt(document.getElementById('challengeXP').value) || 100,
        custom: true
      };

      const customChallenges = JSON.parse(localStorage.getItem('kudisave_challenges')) || [];
      customChallenges.push(newChallenge);
      localStorage.setItem('kudisave_challenges', JSON.stringify(customChallenges));

      closeModal('addModal');
      loadChallenges();
      showToast('Challenge created!');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      document.body.style.overflow = '';
      selectedChallenge = null;
    }

    // Backdrop click to close modals
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      utils.showAlert(message, type);
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '../index.html';
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });
  </script>
</body>
</html>
